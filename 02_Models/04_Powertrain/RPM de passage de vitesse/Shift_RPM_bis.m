%% Calcul de RPM optimal pour le passage de vitesse d'Optimus à
% partir de la courbe de couple réailsé sur banc à Chambéry le 14/05/2019

% Réalisé à partir de la méthode décrite dans le lien :
%http://glennmessersmith.com/shiftpt.html

%On cherche à avoir un couple au roue continu²

%% Paramètres voiture
nb_gear = 6; % nombre de vitesse considérée
%Ratio total: moteur vers roue, pour chaque vitesse

% Transmission
primaire = 36/76; % Rapport primaire

% Etagement origine
K(1) = 12/32; % Rapport de 1ere
K(2) = 16/31; % Rapport de 2eme
K(3) = 18/29; % Rapport de 3eme
K(4) = 22/31; % Rapport de 4eme
K(5) = 23/29; % Rapport de 5eme
K(6) = 24/28; % Rapport de 6eme

final = 1/3.2; % Rapport final (pignon couronne)

Gear_ratio = primaire*K*final;

% Courbe Puissance / rpm
HP =[26.7693245794283 27.3863579411617 27.9279953724586 28.3587054578259 27.9467458755348 27.1107728161179 26.3501956871375 26.3810788686747 27.3395604670977 28.1767152809101 29.0138700947226 29.9581969016077 31.0339610584874 31.9402721395279 32.8065453816469 33.5592126345397 33.4180323760838 32.5566122053492 31.6709266776926 31.3003284992460 31.9548313536812 32.7173701949582 33.5584247982760 34.4371773668120 35.3471282513908 36.2004599698180 37.0760349320904 37.8877111211347 38.7539843632536 39.6249373527790 40.3717115904193 40.9027548071301 40.9341737173266 41.0291924659313 41.6790573231710 42.3612990527740 43.0495591723884 43.8339368348953 44.6237742027097 45.3717538298334 46.2561394276550 47.0308976093820 47.9129433335004 48.6396907733173 49.4938313369752 50.2382924873453 51.0870946724803 51.8051065838053 52.5997970230041 53.4660702651230 54.3074715163969 55.0425096198288 55.8938192251792 56.8146895203729 57.6227259058788 58.4598807196913 59.2970355335037 60.1402566865467 60.9422267328221 61.8145663141716 62.6186162481832 63.4776098832256 64.2699171177267 65.0479251240415 65.8596013130858 66.5931871716716 67.2053359485701 67.6321856362452 68.0788887977657 68.6281682408205 69.2833328777172 69.9566965323055 70.6300601868937 71.1164702961049 71.4572882637835 71.6061893176237 71.7054566868505 71.7087655991580 71.7319279853109 71.8709023022284 72.0429657422215 72.1323063745256 72.1918667960617 72.2183380945221 72.2812074283658 72.4797421668193 72.7212927652711 73.0554929083346 73.3963108760132 73.6014634390818 73.7272021067691 73.8198516513807 73.8198516513807 73.8397051252261 74.0779468113704 74.3823667436658 74.6470797282705 74.8720857651846 75.0573848544079 75.1026066559445 75.0176779067172 74.9514996605660 74.7408322436514 74.4187647790489 74.0746378990628 73.7801447036900 73.7470555806144 73.5981545267743 73.3301326298620 72.9099007668020 72.3870926222076 71.8973736006889 71.3083872099434 70.6598403976618 69.9480106374981 69.1973011577206 68.4632741108271 67.6807163500894 66.8002305417732 66.0670701147697 65.3339096877663 64.5656511552148 63.8129917806846 62.9459385806646 62.0487270084699 61.0587004460482 60.1766547219299 59.4285884328171 58.7267996458344 57.8514268948696 57.1374187674368 56.1122074374781 54.8443425382983 52.8060525568419 53.7281361198817 50.6343031123139 51.6534481030422 48.5086578459380 49.8092809769625 46.4485290432516 47.3948779632136 45.1503324479193 43.9127992448922 41.4256001603769 43.2091038941513 38.1012462620492 40.6612414173307 39.8847499958235 ];
cmot = [ 0 38.5487   38.6362   38.6097   38.0906   37.3282   36.4654   35.8732   36.2616   37.0797   37.8877   38.7200   39.6658   39.6542   39.8572   39.2645   38.4332   37.5575   37.3589   38.0997   38.9081   39.7279   40.5804   41.3131   41.6142   41.4875   41.0424   41.0292   41.3002   41.8163   41.8127   42.3240   42.7966   43.3348   43.9635   44.6253   45.3373   46.0912   46.8026   47.4644   48.0412   48.4537   48.7615   48.9302   48.9964   48.9964   48.9534   48.8640   48.7416   48.7052   48.7052   48.7019   48.6291   48.5558   48.3909   48.1592   47.8813   47.5934   47.3188   47.1269   46.9151   46.6835   46.4419   46.1673   45.9522   45.7801   45.6026   45.5187   45.3731   45.1978   45.0125   44.8487   44.5790   44.3771   44.2514   44.1422   44.0032   43.8742   43.7385   43.5367   43.3348   43.0867   42.8021   42.4845   42.1668   41.8558   41.6837   41.4455   41.1410   40.8333   40.4660   40.1164   39.8048   39.4094   38.9671   38.4112   37.8057   37.3126   36.8229   36.1515   35.3504   34.7433   34.1138   33.2118   32.1896   30.9248   29.6618   28.5286];


RPM_HP = 1.0e+04 *[ 0 0.5038    0.5127    0.5214    0.5289    0.5348    0.5411    0.5490    0.5565    0.5620    0.5664    0.5707    0.5761    0.5784    0.5861    0.5936    0.5995    0.6066    0.6152    0.6227    0.6283    0.6334    0.6397    0.6476    0.6562    0.6635    0.6736    0.6823    0.6911    0.6971    0.7059    0.7146    0.7233    0.7319    0.7406    0.7493    0.7580    0.7666    0.7753    0.7840    0.7926    0.8013    0.8100    0.8187    0.8273    0.8360    0.8447    0.8534    0.8620    0.8707    0.8794    0.8881    0.8967    0.9054    0.9141    0.9227    0.9314    0.9401    0.9488    0.9574    0.9661    0.9748    0.9835    0.9921    1.0008    1.0095    1.0182    1.0268    1.0355    1.0442    1.0528    1.0615    1.0702    1.0789    1.0875    1.0962    1.1049    1.1136    1.1222    1.1309    1.1396    1.1482    1.1569    1.1656    1.1743    1.1829    1.1916    1.2003    1.2090    1.2176    1.2263    1.2350    1.2437    1.2523    1.2610    1.2697    1.2783    1.2870    1.2957    1.3040    1.3123    1.3209    1.3276    1.3312    1.3328    1.3343    1.3356    1.3367];


%% Algo
pas = 50; % précision demandée


RPM_opt =[];
for gear=1:nb_gear-1
    C=0;
    Cmin = 1000;
    for RPM = 7000:pas:13400
        HT = interp1(RPM_HP,cmot,RPM)*K(gear);
        LT = interp1(RPM_HP,cmot,K(gear)/K(gear+1)*RPM)*K(gear+1);
        C = abs(HT-LT);
        if C<Cmin
            RPM_opt(gear) = RPM;
            Cmin = C;
        end
    end
end

%% Results
disp( "Rapport de passage optimaux");
disp(RPM_opt);
plot(RPM_HP,cmot,"DisplayName",'Motor Power (HP)')
hold on
for gear=1:nb_gear-1
    plot(RPM_opt(gear),interp1(RPM_HP,cmot,RPM_opt(gear)),'o',"DisplayName",['Optimal RPM for ',int2str(gear),' to ',int2str(gear+1),' gearshift'])
end
legend("Location",'southeast')
hold off